# Smart EBL - ESPHome Configuration
# Central Electroblock for Motorhomes
# Hardware: ESP32-WROVER-IE-N16R8

substitutions:
  name: smart-ebl
  friendly_name: "Smart EBL"
<<: !include .basics.yaml

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_mode: dio
    board_build.f_flash: 80000000L

esp32:
  board: esp-wrover-kit
  framework:
    type: esp-idf
    version: recommended
  flash_size: 16MB

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

# Bluetooth proxy for BLE devices (optional)
# esp32_ble_tracker:
# bluetooth_proxy:

# =============================================================================
# External Components
# =============================================================================

external_components:
  - source:
      type: local
      path: components
  - source: github://skrebber/esphome-truma_inetbox
    components: ["truma_inetbox"]

# =============================================================================
# I2C Bus Configuration
# =============================================================================

i2c:
  sda: GPIO21
  scl: GPIO22
  scan: true
  frequency: 400kHz

# =============================================================================
# UART Configuration
# =============================================================================

uart:
  # LIN Bus via TJA1021T for Truma CP Plus
  - id: uart_lin
    tx_pin: GPIO12
    rx_pin: GPIO13
    baud_rate: 9600
    stop_bits: 2

# =============================================================================
# CAN Bus Configuration (RV-C)
# =============================================================================

canbus:
  - platform: esp32_can
    id: can_bus
    tx_pin: GPIO15
    rx_pin: GPIO14
    can_id: 0x100
    bit_rate: 250kbps
    on_frame:
      - can_id: 0x0
        can_id_mask: 0x0
        then:
          - lambda: |-
              // RV-C protocol handler - receive all frames
              // x is std::vector<uint8_t> containing the frame data
              ESP_LOGD("can", "Received CAN frame with %d bytes", x.size());

# =============================================================================
# Truma iNetbox (CP Plus Heater Control via LIN)
# =============================================================================

truma_inetbox:
  id: truma
  uart_id: uart_lin
  on_heater_message:
    - lambda: |-
        ESP_LOGD("truma", "Received heater message");

# Truma Climate Controls
climate:
  # Room heating
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: ROOM
    name: "Truma Room Heating"
    id: truma_room

  # Water heating
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: WATER
    name: "Truma Water Heating"
    id: truma_water

# Truma Number Controls
number:
  # Target room temperature
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: TARGET_ROOM_TEMPERATURE
    name: "Truma Target Room Temp"
    id: truma_target_room_temp

  # Target water temperature
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: TARGET_WATER_TEMPERATURE
    name: "Truma Target Water Temp"
    id: truma_target_water_temp

  # Electric power level (for mix mode)
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: ELECTRIC_POWER_LEVEL
    name: "Truma Electric Power Level"
    id: truma_electric_power

# Truma Select Controls
select:
  # Energy mix selection (gas heaters)
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: HEATER_ENERGY_MIX_GAS
    name: "Truma Energy Mix"
    id: truma_energy_mix

  # Fan mode for Combi heaters
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: HEATER_FAN_MODE_COMBI
    name: "Truma Fan Mode"
    id: truma_fan_mode

# =============================================================================
# ADS7830 ADC Hubs
# =============================================================================

ads7830:
  - id: adc_0x48
    address: 0x48
  - id: adc_0x49
    address: 0x49
  - id: adc_0x4A
    address: 0x4A
  - id: adc_0x4B
    address: 0x4B

# =============================================================================
# ADC 1 (0x48)
# =============================================================================

sensor:
# Permanent fuses group
  # Fuse F8 - output 1 (30A)
  - platform: ads7830
    ads7830_id: adc_0x48
    channel: 0
    name: "Fuse F8 Voltage"
    id: fuse_f8_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s
  
  # Fuse F7 - output 2 (30A)
  - platform: ads7830
    ads7830_id: adc_0x48
    channel: 1
    name: "Fuse F7 Voltage"
    id: fuse_f7_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s
  
  # Fuse F6 - output 3 (30A)
  - platform: ads7830
    ads7830_id: adc_0x48
    channel: 2
    name: "Fuse F6 Voltage"
    id: fuse_f6_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

# Light fuses group
  # Fuse F5 - output 1 (xxA)
  - platform: ads7830
    ads7830_id: adc_0x48
    channel: 3
    name: "Fuse F5 Voltage"
    id: fuse_f5_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Fuse F4 - output 2 (xxA)
  - platform: ads7830
    ads7830_id: adc_0x48
    channel: 4
    name: "Fuse F4 Voltage"
    id: fuse_f4_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Fuse F3 - Awning light (10A)
  - platform: ads7830
    ads7830_id: adc_0x48
    channel: 5
    name: "Fuse F3 Voltage"
    id: fuse_f3_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Fuse F2 - Contour light (10A)
  - platform: ads7830
    ads7830_id: adc_0x48
    channel: 6
    name: "Fuse F2 Voltage"
    id: fuse_f2_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

# Pump fuses group
  # Fuse F1 - Water pump (10A)
  - platform: ads7830
    ads7830_id: adc_0x48
    channel: 7
    name: "Fuse F1 Voltage"
    id: fuse_f1_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

# -----------------------------------------------------------------------------
# ADC 2 (0x49)
# -----------------------------------------------------------------------------

# Fridge fuses group
  # Fuse F9 - Fridge permanent (30A)
  - platform: ads7830
    ads7830_id: adc_0x49
    channel: 0
    name: "Fuse F9 Voltage"
    id: fuse_f9_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Fuse F10 - Fridge D+ controlled (30A)
  - platform: ads7830
    ads7830_id: adc_0x49
    channel: 1
    name: "Fuse F10 Voltage"
    id: fuse_f10_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

# AUX fuses group
  # Fuse F11 - AUX output 1 (30A)
  - platform: ads7830
    ads7830_id: adc_0x49
    channel: 2
    name: "Fuse F11 Voltage"
    id: fuse_f11_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Fuse F12 - AUX output 2 (30A)
  - platform: ads7830
    ads7830_id: adc_0x49
    channel: 3
    name: "Fuse F12 Voltage"
    id: fuse_f12_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Fuse F13 - AUX output 3 (30A)
  - platform: ads7830
    ads7830_id: adc_0x49
    channel: 4
    name: "Fuse F13 Voltage"
    id: fuse_f13_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

# 12V fuses group
  # Fuse F14 - 12V output 1 (30A)
  - platform: ads7830
    ads7830_id: adc_0x49
    channel: 5
    name: "Fuse F14 Voltage"
    id: fuse_f14_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Fuse F15 - 12V output 2 (30A)
  - platform: ads7830
    ads7830_id: adc_0x49
    channel: 6
    name: "Fuse F15 Voltage"
    id: fuse_f15_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Fuse F16 - 12V output 3 (30A)
  - platform: ads7830
    ads7830_id: adc_0x49
    channel: 7
    name: "Fuse F16 Voltage"
    id: fuse_f16_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

# -----------------------------------------------------------------------------
# ADC 3 (0x4A)
# -----------------------------------------------------------------------------

# Tank level sensors
  # Fresh water tank level
  - platform: ads7830
    ads7830_id: adc_0x4A
    channel: 0
    name: "Fresh Water Tank Voltage"
    id: tank_fresh_voltage
    unit_of_measurement: "%"
    accuracy_decimals: 0
    filters:
      - calibrate_linear:
          - 0.0 -> 0
          - 3.3 -> 100
    update_interval: 10s

  # Grey water tank level
  - platform: ads7830
    ads7830_id: adc_0x4A
    channel: 1
    name: "Grey Water Tank Voltage"
    id: tank_grey_voltage
    unit_of_measurement: "%"
    accuracy_decimals: 0
    filters:
      - calibrate_linear:
          - 0.0 -> 0
          - 3.3 -> 100
    update_interval: 10s

  # Black water tank level
  - platform: ads7830
    ads7830_id: adc_0x4A
    channel: 2
    name: "Black Water Tank Voltage"
    id: tank_black_voltage
    unit_of_measurement: "%"
    accuracy_decimals: 0
    filters:
      - calibrate_linear:
          - 0.0 -> 0
          - 3.3 -> 100
    update_interval: 10s

# Miscellaneous sensors
  # +3V3 reference voltage
  - platform: ads7830
    ads7830_id: adc_0x4A
    channel: 3
    name: "3.3V Voltage"
    id: voltage_3v3
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 60s
    internal: true

  # Shore power voltage level
  - platform: ads7830
    ads7830_id: adc_0x4A
    channel: 4
    name: "Shore Power Voltage"
    id: shore_power_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 10s

  # Duocontrol gas system status
  - platform: ads7830
    ads7830_id: adc_0x4A
    channel: 5
    name: "Duocontrol Voltage"
    id: duocontrol_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 10s

  # D+ voltage level
  - platform: ads7830
    ads7830_id: adc_0x4A
    channel: 6
    name: "D+ Voltage"
    id: dplus_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 10s

  # Fridge ABS voltage level
  - platform: ads7830
    ads7830_id: adc_0x4A
    channel: 7
    name: "Fridge ABS Voltage"
    id: fridge_abs_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 10s

# -----------------------------------------------------------------------------
# ADC 4 (0x4B)
# -----------------------------------------------------------------------------

# Miscellaneous sensors
  # Battery voltage (via voltage divider)
  - platform: ads7830
    ads7830_id: adc_0x4B
    channel: 0
    name: "Battery Voltage"
    id: battery_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    filters:
      - calibrate_linear:
          - 0.0 -> 0.0
          - 3.3 -> 16.0  # Adjust based on voltage divider ratio
    update_interval: 1s

  # Starter battery voltage
  - platform: ads7830
    ads7830_id: adc_0x4B
    channel: 1
    name: "Starter Battery Voltage"
    id: starter_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    filters:
      - calibrate_linear:
          - 0.0 -> 0.0
          - 3.3 -> 16.0
    update_interval: 5s

  # Output monitoring - Light group output
  - platform: ads7830
    ads7830_id: adc_0x4B
    channel: 2
    name: "Light Output Voltage"
    id: light_out_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Output monitoring - 12V group output
  - platform: ads7830
    ads7830_id: adc_0x4B
    channel: 3
    name: "12V Output Voltage"
    id: voltage_12v_out
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Output monitoring - AUX group output
  - platform: ads7830
    ads7830_id: adc_0x4B
    channel: 4
    name: "AUX Output Voltage"
    id: aux_out_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Output monitoring - Pump output
  - platform: ads7830
    ads7830_id: adc_0x4B
    channel: 5
    name: "Pump Output Voltage"
    id: pump_out_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Output monitoring - Awning Light
  - platform: ads7830
    ads7830_id: adc_0x4B
    channel: 6
    name: "Awning Light Output Voltage"
    id: awning_light_out_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 5s

  # Output monitoring - Contour Light
  - platform: ads7830
    ads7830_id: adc_0x4B
    channel: 7
    name: "Contour Light Output Voltage"
    id: contour_light_out_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    update_interval: 10s
    internal: true

  # -----------------------------------------------------------------------------
  # Fuse Status Binary Sensors (derived from voltage)
  # -----------------------------------------------------------------------------

  # WiFi signal strength
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

  # ESP32 internal temperature
  - platform: internal_temperature
    name: "ESP32 Temperature"
    update_interval: 60s

  # Uptime sensor
  - platform: uptime
    name: "Uptime"
    update_interval: 60s

  # ---------------------------------------------------------------------------
  # Truma Heater Sensors
  # ---------------------------------------------------------------------------

  # Current room temperature
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: CURRENT_ROOM_TEMPERATURE
    name: "Truma Current Room Temp"
    id: truma_current_room_temp

  # Current water temperature
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: CURRENT_WATER_TEMPERATURE
    name: "Truma Current Water Temp"
    id: truma_current_water_temp

  # Heating mode
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: HEATING_MODE
    name: "Truma Heating Mode"
    id: truma_heating_mode

  # Operating status
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: OPERATING_STATUS
    name: "Truma Operating Status"
    id: truma_operating_status

  # Heater error code
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: HEATER_ERROR_CODE
    name: "Truma Error Code"
    id: truma_error_code

# =============================================================================
# Fuse Status (Binary Sensors derived from voltage readings)
# =============================================================================

binary_sensor:
  # Fuse blown detection - voltage below threshold indicates blown fuse
  - platform: template
    name: "Fuse F1 OK"
    id: fuse_f1_ok
    lambda: |-
      return id(fuse_f1_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F2 OK"
    id: fuse_f2_ok
    lambda: |-
      return id(fuse_f2_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F3 OK"
    id: fuse_f3_ok
    lambda: |-
      return id(fuse_f3_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F4 OK"
    id: fuse_f4_ok
    lambda: |-
      return id(fuse_f4_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F5 OK"
    id: fuse_f5_ok
    lambda: |-
      return id(fuse_f5_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F6 OK"
    id: fuse_f6_ok
    lambda: |-
      return id(fuse_f6_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F7 OK"
    id: fuse_f7_ok
    lambda: |-
      return id(fuse_f7_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F8 OK"
    id: fuse_f8_ok
    lambda: |-
      return id(fuse_f8_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F9 OK"
    id: fuse_f9_ok
    lambda: |-
      return id(fuse_f9_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F10 OK"
    id: fuse_f10_ok
    lambda: |-
      return id(fuse_f10_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F11 OK"
    id: fuse_f11_ok
    lambda: |-
      return id(fuse_f11_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F12 OK"
    id: fuse_f12_ok
    lambda: |-
      return id(fuse_f12_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F13 OK"
    id: fuse_f13_ok
    lambda: |-
      return id(fuse_f13_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F14 OK"
    id: fuse_f14_ok
    lambda: |-
      return id(fuse_f14_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F15 OK"
    id: fuse_f15_ok
    lambda: |-
      return id(fuse_f15_voltage).state > 1.0;
    device_class: power

  - platform: template
    name: "Fuse F16 OK"
    id: fuse_f16_ok
    lambda: |-
      return id(fuse_f16_voltage).state > 1.0;
    device_class: power

  # ---------------------------------------------------------------------------
  # Truma Binary Sensors
  # ---------------------------------------------------------------------------

  # CP Plus connected
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: CP_PLUS_CONNECTED
    name: "Truma CP Plus Connected"
    id: truma_connected

  # Room heater active
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: HEATER_ROOM
    name: "Truma Room Heater Active"
    id: truma_heater_room

  # Water heater active
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: HEATER_WATER
    name: "Truma Water Heater Active"
    id: truma_heater_water

  # Gas heater mode
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: HEATER_GAS
    name: "Truma Gas Mode"
    id: truma_gas_mode

  # Electric/Mix mode
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: HEATER_ELECTRICITY
    name: "Truma Electric Mode"
    id: truma_electric_mode

  # Heater has error
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: HEATER_HAS_ERROR
    name: "Truma Has Error"
    id: truma_has_error
    device_class: problem

  # Timer active
  - platform: truma_inetbox
    truma_inetbox_id: truma
    type: TIMER_ACTIVE
    name: "Truma Timer Active"
    id: truma_timer_active

  # ---------------------------------------------------------------------------
  # GPIO Binary Inputs
  # ---------------------------------------------------------------------------

  # SW1 on PCB
  - platform: gpio
    pin:
      number: GPIO34
      mode: INPUT
    name: "SW1"
    id: sw_1
    device_class: running
    filters:
      - delayed_on: 100ms
      - delayed_off: 1s
    on_press:
      - switch.turn_on: relay_light_off_coil

# =============================================================================
# Miscellaneous Switches
# =============================================================================

switch:

# ---------------------------------------------------------------------------
# Internal Relay Coil Drivers (bistable relays need pulse to toggle)
# ---------------------------------------------------------------------------

  # Light group ON/OFF coils (internal)
  - platform: gpio
    id: relay_light_on_coil
    pin: GPIO2
    internal: true
    on_turn_on:
      - delay: 50ms
      - switch.turn_off: relay_light_on_coil
  - platform: gpio
    id: relay_light_off_coil
    pin: GPIO4
    internal: true
    on_turn_on:
      - delay: 50ms
      - switch.turn_off: relay_light_off_coil

  # 12V group ON/OFF coils (internal)
  - platform: gpio
    id: relay_12v_on_coil
    pin: GPIO5
    internal: true
    on_turn_on:
      - delay: 50ms
      - switch.turn_off: relay_12v_on_coil
  - platform: gpio
    id: relay_12v_off_coil
    pin: GPIO18
    internal: true
    on_turn_on:
      - delay: 50ms
      - switch.turn_off: relay_12v_off_coil

  # AUX group ON/OFF coils (internal)
  - platform: gpio
    id: relay_aux_on_coil
    pin: GPIO23
    internal: true
    on_turn_on:
      - delay: 50ms
      - switch.turn_off: relay_aux_on_coil
  - platform: gpio
    id: relay_aux_off_coil
    pin: GPIO25
    internal: true
    on_turn_on:
      - delay: 50ms
      - switch.turn_off: relay_aux_off_coil

  # Pump relay ON/OFF coils (internal)
  - platform: gpio
    id: relay_pump_on_coil
    pin: GPIO26
    internal: true
    on_turn_on:
      - delay: 50ms
      - switch.turn_off: relay_pump_on_coil
  - platform: gpio
    id: relay_pump_off_coil
    pin: GPIO27
    internal: true
    on_turn_on:
      - delay: 50ms
      - switch.turn_off: relay_pump_off_coil

# ---------------------------------------------------------------------------
# User-Facing Switches (exposed to Home Assistant)
# ---------------------------------------------------------------------------

  # Light Group - controls F4-F5 fuses (2x 30A)
  - platform: template
    name: "Light Group"
    id: switch_light
    icon: mdi:lightbulb-group
    optimistic: true
    turn_on_action:
      - switch.turn_on: relay_light_on_coil
    turn_off_action:
      - switch.turn_on: relay_light_off_coil

  # 12V Group - controls F14-F16 fuses (3x 30A)
  - platform: template
    name: "12V Group"
    id: switch_12v
    icon: mdi:power-socket-eu
    optimistic: true
    turn_on_action:
      - switch.turn_on: relay_12v_on_coil
    turn_off_action:
      - switch.turn_on: relay_12v_off_coil

  # AUX Group - controls F11-F13 fuses (3x 30A)
  - platform: template
    name: "AUX Group"
    id: switch_aux
    icon: mdi:power
    optimistic: true
    turn_on_action:
      - switch.turn_on: relay_aux_on_coil
    turn_off_action:
      - switch.turn_on: relay_aux_off_coil

  # Water Pump - controls F1 fuse (10A)
  - platform: template
    name: "Water Pump"
    id: switch_pump
    icon: mdi:water-pump
    optimistic: true
    turn_on_action:
      - switch.turn_on: relay_pump_on_coil
    turn_off_action:
      - switch.turn_on: relay_pump_off_coil

  # EisEx Heater (via BTS6143D smart switch)
  - platform: gpio
    name: "EisEx Heater"
    id: switch_eisex
    icon: mdi:heating-coil
    pin: GPIO33
